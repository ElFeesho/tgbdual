--
-- Created by IntelliJ IDEA.
-- User: sawczc01
-- Date: 15/07/2016
-- Time: 21:03
-- To change this template use File | Settings | File Templates.
--

pokename = {}

pokename[1] = "Bulbasaur"
pokename[2] = "Ivysaur"
pokename[3] = "Venusaur"
pokename[4] = "Charmander"
pokename[5] = "Charmeleon"
pokename[6] = "Charizard"
pokename[7] = "Squirtle"
pokename[8] = "Wartortle"
pokename[9] = "Blastoise"
pokename[10] = "Caterpie"
pokename[11] = "Metapod"
pokename[12] = "Butterfree"
pokename[13] = "Weedle"
pokename[14] = "Kakuna"
pokename[15] = "Beedrill"
pokename[16] = "Pidgey"
pokename[17] = "Pidgeotto"
pokename[18] = "Pidgeot"
pokename[19] = "Rattata"
pokename[20] = "Raticate"
pokename[21] = "Spearow"
pokename[22] = "Fearow"
pokename[23] = "Ekans"
pokename[24] = "Arbok"
pokename[25] = "Pikachu"
pokename[26] = "Raichu"
pokename[27] = "Sandshrew"
pokename[28] = "Sandslash"
pokename[29] = "Nidoran♀"
pokename[30] = "Nidorina"
pokename[31] = "Nidoqueen"
pokename[32] = "Nidoran♂"
pokename[33] = "Nidorino"
pokename[34] = "Nidoking"
pokename[35] = "Clefairy"
pokename[36] = "Clefable"
pokename[37] = "Vulpix"
pokename[38] = "Ninetales"
pokename[39] = "Jigglypuff"
pokename[40] = "Wigglytuff"
pokename[41] = "Zubat"
pokename[42] = "Golbat"
pokename[43] = "Oddish"
pokename[44] = "Gloom"
pokename[45] = "Vileplume"
pokename[46] = "Paras"
pokename[47] = "Parasect"
pokename[48] = "Venonat"
pokename[49] = "Venomoth"
pokename[50] = "Diglett"
pokename[51] = "Dugtrio"
pokename[52] = "Meowth"
pokename[53] = "Persian"
pokename[54] = "Psyduck"
pokename[55] = "Golduck"
pokename[56] = "Mankey"
pokename[57] = "Primeape"
pokename[58] = "Growlithe"
pokename[59] = "Arcanine"
pokename[60] = "Poliwag"
pokename[61] = "Poliwhirl"
pokename[62] = "Poliwrath"
pokename[63] = "Abra"
pokename[64] = "Kadabra"
pokename[65] = "Alakazam"
pokename[66] = "Machop"
pokename[67] = "Machoke"
pokename[68] = "Machamp"
pokename[69] = "Bellsprout"
pokename[70] = "Weepinbell"
pokename[71] = "Victreebel"
pokename[72] = "Tentacool"
pokename[73] = "Tentacruel"
pokename[74] = "Geodude"
pokename[75] = "Graveler"
pokename[76] = "Golem"
pokename[77] = "Ponyta"
pokename[78] = "Rapidash"
pokename[79] = "Slowpoke"
pokename[80] = "Slowbro"
pokename[81] = "Magnemite"
pokename[82] = "Magneton"
pokename[83] = "Farfetch'd"
pokename[84] = "Doduo"
pokename[85] = "Dodrio"
pokename[86] = "Seel"
pokename[87] = "Dewgong"
pokename[88] = "Grimer"
pokename[89] = "Muk"
pokename[90] = "Shellder"
pokename[91] = "Cloyster"
pokename[92] = "Gastly"
pokename[93] = "Haunter"
pokename[94] = "Gengar"
pokename[95] = "Onix"
pokename[96] = "Drowzee"
pokename[97] = "Hypno"
pokename[98] = "Krabby"
pokename[99] = "Kingler"
pokename[100] = "Voltorb"
pokename[101] = "Electrode"
pokename[102] = "Exeggcute"
pokename[103] = "Exeggutor"
pokename[104] = "Cubone"
pokename[105] = "Marowak"
pokename[106] = "Hitmonlee"
pokename[107] = "Hitmonchan"
pokename[108] = "Lickitung"
pokename[109] = "Koffing"
pokename[110] = "Weezing"
pokename[111] = "Rhyhorn"
pokename[112] = "Rhydon"
pokename[113] = "Chansey"
pokename[114] = "Tangela"
pokename[115] = "Kangaskhan"
pokename[116] = "Horsea"
pokename[117] = "Seadra"
pokename[118] = "Goldeen"
pokename[119] = "Seaking"
pokename[120] = "Staryu"
pokename[121] = "Starmie"
pokename[122] = "Mr. Mime"
pokename[123] = "Scyther"
pokename[124] = "Jynx"
pokename[125] = "Electabuzz"
pokename[126] = "Magmar"
pokename[127] = "Pinsir"
pokename[128] = "Tauros"
pokename[129] = "Magikarp"
pokename[130] = "Gyarados"
pokename[131] = "Lapras"
pokename[132] = "Ditto"
pokename[133] = "Eevee"
pokename[134] = "Vaporeon"
pokename[135] = "Jolteon"
pokename[136] = "Flareon"
pokename[137] = "Porygon"
pokename[138] = "Omanyte"
pokename[139] = "Omastar"
pokename[140] = "Kabuto"
pokename[141] = "Kabutops"
pokename[142] = "Aerodactyl"
pokename[143] = "Snorlax"
pokename[144] = "Articuno"
pokename[145] = "Zapdos"
pokename[146] = "Moltres"
pokename[147] = "Dratini"
pokename[148] = "Dragonair"
pokename[149] = "Dragonite"
pokename[150] = "Mewtwo"
pokename[151] = "Mew"
pokename[152] = "Chikorita"
pokename[153] = "Bayleef"
pokename[154] = "Meganium"
pokename[155] = "Cyndaquil"
pokename[156] = "Quilava"
pokename[157] = "Typhlosion"
pokename[158] = "Totodile"
pokename[159] = "Croconaw"
pokename[160] = "Feraligatr"
pokename[161] = "Sentret"
pokename[162] = "Furret"
pokename[163] = "Hoothoot"
pokename[164] = "Noctowl"
pokename[165] = "Ledyba"
pokename[166] = "Ledian"
pokename[167] = "Spinarak"
pokename[168] = "Ariados"
pokename[169] = "Crobat"
pokename[170] = "Chinchou"
pokename[171] = "Lanturn"
pokename[172] = "Pichu"
pokename[173] = "Cleffa"
pokename[174] = "Igglybuff"
pokename[175] = "Togepi"
pokename[176] = "Togetic"
pokename[177] = "Natu"
pokename[178] = "Xatu"
pokename[179] = "Mareep"
pokename[180] = "Flaaffy"
pokename[181] = "Ampharos"
pokename[182] = "Bellossom"
pokename[183] = "Marill"
pokename[184] = "Azumarill"
pokename[185] = "Sudowoodo"
pokename[186] = "Politoed"
pokename[187] = "Hoppip"
pokename[188] = "Skiploom"
pokename[189] = "Jumpluff"
pokename[190] = "Aipom"
pokename[191] = "Sunkern"
pokename[192] = "Sunflora"
pokename[193] = "Yanma"
pokename[194] = "Wooper"
pokename[195] = "Quagsire"
pokename[196] = "Espeon"
pokename[197] = "Umbreon"
pokename[198] = "Murkrow"
pokename[199] = "Slowking"
pokename[200] = "Misdreavus"
pokename[201] = "Unown"
pokename[202] = "Wobbuffet"
pokename[203] = "Girafarig"
pokename[204] = "Pineco"
pokename[205] = "Forretress"
pokename[206] = "Dunsparce"
pokename[207] = "Gligar"
pokename[208] = "Steelix"
pokename[209] = "Snubbull"
pokename[210] = "Granbull"
pokename[211] = "Qwilfish"
pokename[212] = "Scizor"
pokename[213] = "Shuckle"
pokename[214] = "Heracross"
pokename[215] = "Sneasel"
pokename[216] = "Teddiursa"
pokename[217] = "Ursaring"
pokename[218] = "Slugma"
pokename[219] = "Magcargo"
pokename[220] = "Swinub"
pokename[221] = "Piloswine"
pokename[222] = "Corsola"
pokename[223] = "Remoraid"
pokename[224] = "Octillery"
pokename[225] = "Delibird"
pokename[226] = "Mantine"
pokename[227] = "Skarmory"
pokename[228] = "Houndour"
pokename[229] = "Houndoom"
pokename[230] = "Kingdra"
pokename[231] = "Phanpy"
pokename[232] = "Donphan"
pokename[233] = "Porygon2"
pokename[234] = "Stantler"
pokename[235] = "Smeargle"
pokename[236] = "Tyrogue"
pokename[237] = "Hitmontop"
pokename[238] = "Smoochum"
pokename[239] = "Elekid"
pokename[240] = "Magby"
pokename[241] = "Miltank"
pokename[242] = "Blissey"
pokename[243] = "Raikou"
pokename[244] = "Entei"
pokename[245] = "Suicune"
pokename[246] = "Larvitar"
pokename[247] = "Pupitar"
pokename[248] = "Tyranitar"
pokename[249] = "Lugia"
pokename[250] = "Ho-Oh"
pokename[251] = "Celebi"

function numberstring(number, base)
    local digits = {}
    for i=0,9 do digits[i] = string.char(string.byte('0')+i) end
    for i=10,36 do digits[i] = string.char(string.byte('A')+i-10) end

    local s = ""
    repeat
        local remainder = math.fmod(number,base)
        s = digits[remainder]..s
        number = (number-remainder)/base
    until number==0
    return s
end

function create_pokemon_actor(number)
    local pokemon = {
        hp = function(self)
            return bridge.read_8bit_value(0x1d02 + (0x30*(number-1)));
        end,
        hp_max = function(self)
            return bridge.read_8bit_value(0x1d04 + (0x30*(number-1)));
        end,
        roster_position = function(self)
            return number
        end,
        pokemon_number = function(self)
            return bridge.read_8bit_value(0x1cd8+(number-1))
        end,
        is_present = function(self)
            return self:pokemon_number() > 0 and self:pokemon_number() < 252
        end,
        to_string = function(self)
            if (self:is_present()) then
                local pokemon_num = self:pokemon_number()
                local pokemon_name = pokename[pokemon_num]
                return string.format("%d#: %-16s (%3d)\t %3d/%-3d", number, pokemon_name, pokemon_num, self:hp(), self:hp_max())
            else
                return number.."#: Not in roster"
            end
        end
    }
    setmetatable(pokemon, {
        __tostring = function(self)
            return self:to_string()
        end
    })

    return pokemon
end

function create_poke_hud(actor, x)
    local y = 288 - 50

    bridge.add_rect(x, y, 50, 50, 0xffff0000, 0x88ffffff)

    bridge.add_rect(x+2, y+2, 46, 8, 0xff000000, 0xff000000)
    bridge.add_rect(x+4, y+4, 42, 4, 0xff000000, 0xff444444)
    bridge.add_rect(x+4, y+4, math.floor(42.0*(actor:hp()/actor:hp_max())), 4, 0xff000000, 0xff00ff00)
    bridge.add_image("imgs/"..actor:pokemon_number()..".png", x+4, y+10)

end

local team = {create_pokemon_actor(1), create_pokemon_actor(2), create_pokemon_actor(3), create_pokemon_actor(4), create_pokemon_actor(5), create_pokemon_actor(6)}

function tap_keys(keys, duration, interval)
    for i = 0, #keys do
        bridge.queue_key(keys[i], interval*i, duration)
    end
end

function activate()

--    print("Selected pokemon is "..bridge.read_8bit_value(0xfa9))
--    bridge.set_8bit_value(0xfa9, 4)

--    for _, v in pairs(team) do
--        print(v)
--    end

    bridge.set_8bit_value(0xfa9, 0)
    bridge.set_8bit_value(0xf74, 0)
    tap_keys({GameBoy.KEY_START, GameBoy.KEY_DOWN, GameBoy.KEY_A, GameBoy.KEY_DOWN, GameBoy.KEY_A, GameBoy.KEY_A}, 100, 500)

    --bridge.set_8bit_value(0x0f74, 5)

end

function render_hud(active_team)
    local start_x = (320 - (#active_team * 52))/2
    for k, v in pairs(active_team) do
        create_poke_hud(v, math.floor(start_x + (k-1)*52))
    end
end

function filter()
    local result = {}
    local start = 1
    for k, v in pairs(team) do
        if (v:is_present()) then
            result[start] = v
            start = start + 1
        end
    end
    return result
end

function tick()
    bridge.clear_canvas()

    render_hud(filter(team))
end

